TODO : 

<!-- omit in toc -->
# Juice Shop

we can register with a pwd < 5 (no backend check)


---
author: NONCLERCQ Basile, BELLEC Louison, BOUVARD Alexandre, GUILLAUMIE Bilal, TORRET Lucas
<!-- omit in toc -->
title: How to protect your application with middlewares ?
---

<!-- omit in toc -->
## Table of content:
- [Setup](#setup)
- [SQL injection](#sql-injection)
  - [Vulnerability Exploitation](#vulnerability-exploitation)
  - [Fix](#fix)
- [XSS](#xss)
  - [Vulnerability Exploitation](#vulnerability-exploitation-1)
    - [DONNER UN NOM](#donner-un-nom)
  - [Fix](#fix-1)
- [Sensitive Data Exposure](#sensitive-data-exposure)
  - [Vulnerability Exploitation](#vulnerability-exploitation-2)
    - [Exploitation 1 - Admin bypass](#exploitation-1---admin-bypass)
    - [Exploitation 2 - FTP](#exploitation-2---ftp)
    - [Exploitation 3 - Coupon bypass](#exploitation-3---coupon-bypass)
  - [Fix](#fix-2)
- [Broken authentification](#broken-authentification)
  - [Vulnerability Exploitation](#vulnerability-exploitation-3)
  - [Fix](#fix-3)
- [Broken Access Control](#broken-access-control)
  - [Vulnerability Exploitation](#vulnerability-exploitation-4)
  - [Fix](#fix-4)
- [Using Components with Known Vulnerabilities](#using-components-with-known-vulnerabilities)
  - [Vulnerability](#vulnerability)

## Setup

1. Install Docker
2. Run docker pull bkimminich/juice-shop
3. Run docker run --rm -p 3000:3000 bkimminich/juice-shop
4. Browse to http://localhost:3000

Juice Shop Link: https://hub.docker.com/r/bkimminich/juice-shop

Structure for each section: 

* Vulnerability
  * Demonstration 
  * Fix

## SQL injection 

### Vulnerability Exploitation

We can inject SQL in the username section of the login page.
We enter  
```
' or 1=1; 
```
to match all users and login as an user.

![SQLi](./images/sqliVuln1.png)

![SQLi](./images/sqliVuln2.png)

<!-- ![SQLi](./images/sqliVuln3.png) -->

### Fix

> ```Need: WAF```

Choice: ModSecurity 

Works for Apache and Nginx

Prevent:

* SQL Injection
* Insuring the content type matches the body data.
* Protection against malformed POST requests.
* HTTP Protocol Protection
* Real-time Blacklist Lookups
* HTTP Denial of Service Protections
* Generic Web Attack Protection
* Error Detection and Hiding

Result: 

Repository : https://hub.docker.com/r/owasp/modsecurity-crs/

## XSS 

### Vulnerability Exploitation

#### DONNER UN NOM

We can inject javascript code via an iframe in the search bar:


Payload: 
```bash
<iframe src="javascript:alert(`Nice XSS`)">
```

![XSS](./images/XSSVuln1.png)

![XSS](./images/XSSVuln2.png)

#### Cookie Exploitation

As above, we use the following playload: 

```bash
<iframe src="javascript:console.log(document.cookies)">
```

Here's the result :

![Cookie](./images/Injection1.png)

Here's the decode result :

![Cookie](./images/Injection2.png)

From it, we now know taht there is a role (treated in the following sections). The MD5 encrypt password etc... 


### Fix

## Sensitive Data Exposure

### Vulnerability Exploitation

#### Exploitation 1 - Admin bypass

In the review section of many product, we can find users' emails incuding the admin one: `admin@juice-sh.op`. He comments "I bought it, would buy again. 5/7" in the review of Eggfruit Juice (500ml).

Then, with bruteforcing or basic input (like admin123) we can enter as the admin account. This one can also fit with Broken Authentification.

#### Exploitation 2 - FTP

In the section "about us" we can see a link "Check out our boring terms of use if you are interested in such lame stuff" with the url: `ip:port/ftp/legal.md`.

We can go to the ftp directory and see a lot of files, probably not for basic users. But we can't (at the moment) download all the files. When trying to download` eastere.gg`, we got the following error: `403 Error: Only .md and .pdf files are allowed!`.

[I](http://localhost:3000/ftp/acquisitions.md)

![Sensitive Data Exposure](./images/SensitiveDataExposure1.png)

![Sensitive Data Exposure](./images/SensitiveDataExposure4.png)

But if we add a null bytes `%00` then `.md` like that:

![Sensitive Data Exposure](./images/SensitiveDataExposure3.png)

(`%25` stand for `%` in hexa) 

It works. 

![Sensitive Data Exposure](./images/SensitiveDataExposure2.png)

#### Exploitation 3 - Coupon bypass

While reading the source code, we stumble upon:

![Sensitive Data Exposure](./images/SensitiveDataExposure5.png)

Here's the source code on how they treat coupon related things. We can see how they create their coupon: 

![Sensitive Data Exposure](./images/SensitiveDataExposure6.png)

They are using `z85` encoding.

Moreover, as the coupon is generated from the current date and the discount pourcentage, we could create one. 
Exemple: `FEB21-99` stand for 99% of discount (Max 8 characters).

We just have to encode first in `hexadecimal` and then in `z85`. 

Demonstration: 

![Sensitive Data Exposure](./images/SensitiveDataExposure7.png)

![Sensitive Data Exposure](./images/SensitiveDataExposure8.png)

### Exploitation 4



### Fix


## Broken authentification

### Vulnerability Exploitation

Even if we can, from admin account, do malicious things, there are others ways. 

In the same way as we did before with the admin user, we can see `jim@juice-sh.op` who wrote: Fresh out of a replicator.". From here, with his email, we can try to answer his security question in the "forgot password" section: "your eldest siblings middle name?". 
With some research, we can reset his password and take control of the account.  
By typing "replicator" on google, we can find a Star Trek reference that leads us to find the answer to the question: "Samuel" for George Samuel Kirk, the eldest brother of James Tiberius Kirk.

![Vulnerability Exploitation](./images/brokenAuthVuln1.png)
![Vulnerability Exploitation](./images/brokenAuthVuln2.png)

### Fix

## Broken Access Control

### Vulnerability Exploitation

Once we have a account, we can go to our basket and check with `burp` the corresponding url:

![Broken Access Control](./images/BrokenAccessControl1.png)

By simply replacing the `2` by an other figure like `1`, we can get the basket of an other user (in this case, the admin user).

![Broken Access Control](./images/BrokenAccessControl2.png)

### Fix

## Using Components with Known Vulnerabilities

### Vulnerability 

When we audit the code (run `npm install` and then `npm audit`) :

![ Using Components with Known Vulnerabilities](./images/UsingComponentsKnownVulnerabilities1.png)

We're seeing a critical vulerability for the jsonwebtoken package :

```
npm WARN deprecated jsonwebtoken@0.4.0: Critical vulnerability fix in v5.0.0. 
```
See https://auth0.com/blog/2015/03/31/critical-vulnerabilities-in-json-web-token-libraries/

After a quick internet search:

POC : https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries/

We can also find:

```
npm WARN deprecated jws@0.2.6: Security update: Versions below 3.0.0 are deprecated.
```

POC : https://snyk.io/test/npm/jws/0.2.6


> Note: Audit result -> [Audit](./message.txt)

![Audit picture](./images/auditResult.png)

