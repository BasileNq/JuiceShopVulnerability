---
author: NONCLERCQ Basile, BELLEC Louison, BOUVARD Alexandre, GUILLAUMIE Bilal, TORRET Lucas
title: JuiceShop, How to protect your application/network with middlewares ?
---

# Preamble

In order to develop our argumentation and illustrate some cases, we are going to work on the JuiceShop project, the most insecure web application. After finding all or some vulnerabilities, we will set up one or several security solutions to resolve theses vulnerabilities without touching the source code of Juice Shop.

<!-- omit in toc -->
# Table of content:
- [Preamble](#preamble)
- [Setup](#setup)
- [Juice Shop Vulnerabilities](#juice-shop-vulnerabilities)
  - [SQL injection](#sql-injection)
    - [Exploitation 1 - Basic SQLi](#exploitation-1---basic-sqli)
  - [XSS](#xss)
    - [Exploitation 1 - Basic XSS](#exploitation-1---basic-xss)
    - [Exploitation 2 - Cookie Exploitation](#exploitation-2---cookie-exploitation)
  - [Sensitive Data Exposure](#sensitive-data-exposure)
    - [Exploitation 1 - Admin bypass](#exploitation-1---admin-bypass)
    - [Exploitation 2 - FTP](#exploitation-2---ftp)
    - [Exploitation 3 - Coupon bypass](#exploitation-3---coupon-bypass)
  - [Broken authentification](#broken-authentification)
    - [Exploitation 1 - Broken Reset Password](#exploitation-1---broken-reset-password)
  - [Broken Access Control](#broken-access-control)
    - [Exploitation 1 - See other'user basket](#exploitation-1---see-otheruser-basket)
    - [Exploitation 2 - Register with a password of less than 5 characters](#exploitation-2---register-with-a-password-of-less-than-5-characters)
  - [Using Components with Known Vulnerabilities](#using-components-with-known-vulnerabilities)
    - [Exploitation 1 - Deprecated Packages](#exploitation-1---deprecated-packages)
- [Juice Shop Securisation](#juice-shop-securisation)
  - [Reverse Proxy](#reverse-proxy)
  - [IDS / IPD (Intrusion Detection/Prevention System)](#ids--ipd-intrusion-detectionprevention-system)
  - [WAF](#waf)
  - [SSL](#ssl)

# Setup

1. Install Docker
2. Run docker pull bkimminich/juice-shop
3. Run docker run --rm -p 3000:3000 bkimminich/juice-shop
4. Browse to http://localhost:3000

Juice Shop Link: https://hub.docker.com/r/bkimminich/juice-shop

Structure for each section: 

* Vulnerability
  * Demonstration 
  * Fix


# Juice Shop Vulnerabilities

## SQL injection 

### Exploitation 1 - Basic SQLi

We can inject SQL in the username section of the login page. We can write  
```
' or 1=1; 
```  
to match all users and login as an user.

![SQLi](./images/sqliVuln1.png)

![SQLi](./images/sqliVuln2.png)

> ```Need: WAF```

Choice: ModSecurity 

Works for Apache and Nginx



## XSS 


### Exploitation 1 - Basic XSS

We can inject javascript code via an iframe in the search bar:  


Payload: 
```bash
<iframe src="javascript:alert(`Nice XSS`)">
```

![XSS](./images/XSSVuln1.png)

![XSS](./images/XSSVuln2.png)

### Exploitation 2 - Cookie Exploitation

As above, we use the following playload: 

```bash
<iframe src="javascript:console.log(document.cookies)">
```

Here's the result :

![Cookie](./images/Injection1.png)

Here's the decode result :

![Cookie](./images/Injection2.png)

From it, we now know that there is a role (treated in the following sections). The MD5 encrypt password etc... 


## Sensitive Data Exposure


### Exploitation 1 - Admin bypass

In the review section of many product, we can find users' emails incuding the admin one: `admin@juice-sh.op`. He comments "I bought it, would buy again. 5/7" in the review of Eggfruit Juice (500ml).

Then, with bruteforcing or basic input (like admin123) we can enter as the admin account. This one can also fit with Broken Authentification.

### Exploitation 2 - FTP

In the section "about us" we can see a link "Check out our boring terms of use if you are interested in such lame stuff" with the url: `ip:port/ftp/legal.md`.

We can go to the ftp directory and see a lot of files, probably not for basic users. But we can't (at the moment) download all the files. When trying to download` eastere.gg`, we got the following error: `403 Error: Only .md and .pdf files are allowed!`.

[I](http://localhost:3000/ftp/acquisitions.md)

![Sensitive Data Exposure](./images/SensitiveDataExposure1.png)

![Sensitive Data Exposure](./images/SensitiveDataExposure4.png)

But if we add a null bytes `%00` then `.md` like that:

![Sensitive Data Exposure](./images/SensitiveDataExposure3.png)

(`%25` stand for `%` in hexa) 

It works. 

![Sensitive Data Exposure](./images/SensitiveDataExposure2.png)

### Exploitation 3 - Coupon bypass

While reading the source code, we stumble upon:  

![Sensitive Data Exposure](./images/SensitiveDataExposure5.png)

Here's the source code on how they treat coupon related things. We can see how they create their coupon: 

![Sensitive Data Exposure](./images/SensitiveDataExposure6.png)

They are using `z85` encoding.

Moreover, as the coupon is generated from the current date and the discount pourcentage, we could create one.  
Exemple: `FEB21-99` stand for 99% of discount (Max 8 characters).

We just have to encode first in `hexadecimal` and then in `z85`. 

Demonstration: 

![Sensitive Data Exposure](./images/SensitiveDataExposure7.png)

![Sensitive Data Exposure](./images/SensitiveDataExposure8.png)


## Broken authentification

### Exploitation 1 - Broken Reset Password

Even if we can, from admin account, do malicious things, there are others ways. 

In the same way as we did before with the admin user, we can see `jim@juice-sh.op` who wrote: Fresh out of a replicator.". From here, with his email, we can try to answer his security question in the "forgot password" section: "your eldest siblings middle name?".  
With some research, we can reset his password and take control of the account.  
By typing "replicator" on google, we can find a Star Trek reference that leads us to find the answer to the question: "Samuel" for George Samuel Kirk, the eldest brother of James Tiberius Kirk.

![Vulnerability Exploitation](./images/brokenAuthVuln1.png)
![Vulnerability Exploitation](./images/brokenAuthVuln2.png)

## Broken Access Control

### Exploitation 1 - See other'user basket

Once we have a account, we can go to our basket and check with `burp` the corresponding url:

![Broken Access Control](./images/BrokenAccessControl1.png)

By simply replacing the `2` by an other figure like `1`, we can get the basket of an other user (in this case, the admin user).

![Broken Access Control](./images/BrokenAccessControl2.png)

### Exploitation 2 - Register with a password of less than 5 characters

As we can see in the picture, the application requires a 5-20 length password.

![Broken Access Control](./images/5passwd1.png)

But, with burpsuite, we can bypass this. In fact the length check is done in the frontend only instead of in the backend as well. We can finally modify the password as we want (even enterering two differents passwords) and create an account.

![Broken Access Control](./images/5passwd2.png)

![Broken Access Control](./images/5passwd3.png)

## Using Components with Known Vulnerabilities

### Exploitation 1 - Deprecated Packages

When we audit the code (run `npm install` and then `npm audit`) :

![ Using Components with Known Vulnerabilities](./images/UsingComponentsKnownVulnerabilities1.png)

We are seeing a critical vulerability for the jsonwebtoken package :

```
npm WARN deprecated jsonwebtoken@0.4.0: Critical vulnerability fix in v5.0.0. 
```
See https://auth0.com/blog/2015/03/31/critical-vulnerabilities-in-json-web-token-libraries/

After a quick internet search:

POC : https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries/

We can also find:

```
npm WARN deprecated jws@0.2.6: Security update: Versions below 3.0.0 are deprecated.
```

POC : https://snyk.io/test/npm/jws/0.2.6


> Note: Audit result -> [Audit](./message.txt)

![Audit picture](./images/auditResult.png)


# Juice Shop Securisation 

## Reverse Proxy 

Reverse Proxy allow us to not directly expose our web app / server. Indeed, it ensures that our backend server remains unknow. As reverse proxy, we can use Apache or Nginx. 

We could also encrypting the connection between the client and the proxy with TLS/SSL in order to get a securized transmission.

![IPS / IDS](./images/ReverseProxy.png)


## IDS / IPD (Intrusion Detection/Prevention System)

> Note: An IDS analyse the traffic on the network et generate logs while an IPS stand side to the WAF and reject somes packets.

![IPS / IDS](./images/IPSIDS.png)

The second thing we can do is to add an IPS **fail2ban**. Fail2ban ignores requests from malicious IP addresses by scanning logs, for example if they fail many times in authentifications events. So, it prevents Bruteforce type attacks.

About IDS, we can use **Snort**. It uses a serie of rules that help define malicious network activities and generate alerts for packets whose match.


## WAF 

Initially for Apache (but now also available for Nginx), **ModSecurity** is a web application firewall. It works on the layer 7 of the OSI model. It analyses every packet from an external source. We distinguish two distinct components:

* An IDS/IPS engine.
* A rule set for filtering packets. (allow or disallox list)

Its usage is vast. It can detect intrusion, spams, exploit use, bruteforce ... and stop them. But it also hides versions and stop explicit error messages.

Just to get an idea, it can prevent, for example, from:  

* SQL Injection
* Insuring the content type matches the body data.
* Protection against malformed POST requests.
* HTTP Protocol Protection
* Real-time Blacklist Lookups
* HTTP Denial of Service Protections
* Generic Web Attack Protection
* Error Detection and Hiding

For the deployment, we have two choices :

* Embeded: Can be usefull if you don't want to modify your architecture.
* Reverse proxy: Even better choice for security because it adds a separate security layer. It also allows scalability.

Repository : https://hub.docker.com/r/owasp/modsecurity-crs/

> Note: See Owasp ModSecurity Core Rule Set (set of generic attack detection rules) : https://owasp.org/www-project-modsecurity-core-rule-set/
> 
Modsecurity is the best known WAF. But others exist like NAXSI, App protect for Nginx.

## SSL 

In order to maintain confidentiality and increase security, we can implement/activate the TLS/SSL protocol on our Reverse Proxy (or server).

![IPS / IDS](./images/SSL.png)